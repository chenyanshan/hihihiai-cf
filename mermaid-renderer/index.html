<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Pro: 智能渲染工具</title>
    <style>
        :root {
            --secondary-color: #f6821f;
            --green-color: #28a745;
            --dark-grey: #333;
            --light-grey: #f0f2f5;
            --white: #ffffff;
            --border-color: #ccc;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--light-grey);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--dark-grey);
        }
        header {
            background-color: var(--dark-grey);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 10;
        }
        .container {
            display: flex;
            flex-grow: 1;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden; /* 防止外层容器被撑开 */
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .panel-header {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        #mermaid-input {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 15px;
            font-family: "SF Mono", "Courier New", Courier, monospace;
            font-size: 1rem;
            resize: none;
            flex-grow: 1;
        }
        .output-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            padding: 1rem;
            min-height: 0; /* flex 布局下的关键属性，防止子元素溢出 */
        }
        #graph-output {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* 确保在任何情况下都可滚动 */
            flex-grow: 1;
        }
        /* ---- 关键修复 START ---- */
        #graph-output svg {
            /* * 1. `max-width` 和 `max-height` 确保SVG不会超出其容器的边界。
             * 2. `!important` 用于强制覆盖 Mermaid 可能添加的内联 style 属性 (例如 style="width: 2000px;")，
             * 这是确保我们自己的缩放规则能够生效的关键。
             */
            max-width: 100% !important;
            max-height: 100% !important;
        }
        /* ---- 关键修复 END ---- */
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .button:hover { opacity: 0.85; }
        .button.secondary { background-color: var(--secondary-color); }
        .button.success { background-color: var(--green-color); }
    </style>
</head>
<body>

    <header><h1>Mermaid Pro: 智能渲染工具</h1></header>
    
    <div class="container">
        <div class="panel">
            <h3 class="panel-header">1. 在此粘贴或输入 Mermaid 代码 (自动兼容渲染)</h3>
            <textarea id="mermaid-input"></textarea>
            <div class="actions">
                <button id="download-svg-button" class="button secondary">下载为 SVG</button>
                <button id="download-png-button" class="button success">下载为 PNG</button>
            </div>
        </div>
        
        <div class="panel">
            <h3 class="panel-header">2. 渲染结果</h3>
            <div class="output-container"><div id="graph-output"><p>请输入代码以开始...</p></div></div>
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        const inputArea = document.getElementById('mermaid-input');
        const outputDiv = document.getElementById('graph-output');
        const downloadSvgButton = document.getElementById('download-svg-button');
        const downloadPngButton = document.getElementById('download-png-button');

        let lastValidSvg = '';
        mermaid.initialize({ startOnLoad: false, theme: 'default' });

        const preprocessMermaidCode = (code) => {
            const regex = /^(\s*subgraph\s+)(?!")(.+)/gm;
            return code.replace(regex, '$1"$2"');
        };

        const renderGraph = async () => {
            const rawCode = inputArea.value;
            const processedCode = preprocessMermaidCode(rawCode);

            if (!processedCode.trim()) {
                outputDiv.innerHTML = '<p>请输入代码以开始...</p>';
                lastValidSvg = '';
                return;
            }
            
            try {
                await mermaid.parse(processedCode);
                const { svg } = await mermaid.render(`mermaid-graph-${Date.now()}`, processedCode);
                outputDiv.innerHTML = svg;
                lastValidSvg = svg;
            } catch (error) {
                console.error("Mermaid syntax error:", error.message);
            }
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        };
        
        const download = (filename, blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        inputArea.addEventListener('input', debounce(renderGraph, 300));

        downloadSvgButton.addEventListener('click', () => {
            if (!lastValidSvg) { alert('没有可下载的图表！'); return; }
            download('mermaid-graph.svg', new Blob([lastValidSvg], { type: 'image/svg+xml;charset=utf-8' }));
        });
        
        downloadPngButton.addEventListener('click', () => {
            if (!lastValidSvg) { alert('没有可下载的图表！'); return; }
            
            const svgElement = outputDiv.querySelector('svg');
            if (!svgElement) { alert('找不到图表元素。'); return; }

            const viewBox = svgElement.getAttribute('viewBox');
            if (!viewBox) { alert('无法从图表获取准确尺寸，无法生成PNG。'); return; }
            
            const viewBoxParts = viewBox.split(/[\s,]+/);
            const intrinsicWidth = parseFloat(viewBoxParts[2]);
            const intrinsicHeight = parseFloat(viewBoxParts[3]);
            
            if (isNaN(intrinsicWidth) || isNaN(intrinsicHeight) || intrinsicWidth <= 0 || intrinsicHeight <= 0) {
                 alert('读取到无效的图表尺寸，无法生成PNG。'); return;
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(lastValidSvg);

            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const padding = 20;
                const dpr = window.devicePixelRatio || 1;
                
                canvas.width = (intrinsicWidth + padding * 2) * dpr;
                canvas.height = (intrinsicHeight + padding * 2) * dpr;

                ctx.scale(dpr, dpr);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, padding, padding, intrinsicWidth, intrinsicHeight);

                canvas.toBlob((blob) => {
                    if (blob) { download('mermaid-graph.png', blob); }
                }, 'image/png');
            };
            
            img.onerror = () => { alert("图片加载失败，无法生成PNG。"); };
        });

        window.addEventListener('load', () => {
            inputArea.value = `graph TD
    A[欢迎使用 Mermaid Pro] --> B{输入一个非常非常高的图表代码};
    B --> C[它会自动缩小];
    C --> D[以适应屏幕大小];
    D --> E[并且还可以滚动查看哦];
    E --> F[超长内容];
    F --> G[超长内容];
    G --> H[超长内容];
    H --> I[超长内容];
    I --> J[超长内容];
    J --> K[超长内容];
    K --> L[超长内容];
    L --> M[超长内容];
    M --> N[超长内容];`;
            renderGraph();
        });
    </script>
</body>
</html>
