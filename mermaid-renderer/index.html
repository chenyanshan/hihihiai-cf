<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hihihiai MM: Mermaid 实时渲染工具</title>
    <style>
        :root {
            --secondary-color: #f6821f;
            --green-color: #28a745;
            --dark-grey: #333;
            --light-grey: #f0f2f5;
            --white: #ffffff;
            --border-color: #ccc;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--light-grey);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--dark-grey);
        }
        header {
            background-color: var(--dark-grey);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 10;
        }
        .container {
            display: flex;
            flex-grow: 1;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .panel-header {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        #mermaid-input {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 15px;
            font-family: "SF Mono", "Courier New", Courier, monospace;
            font-size: 1rem;
            resize: none;
            flex-grow: 1;
        }
        .output-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            padding: 1rem;
        }
        #graph-output {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            flex-grow: 1;
        }
        #graph-output svg {
            max-width: 100%;
            max-height: 100%;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .button:hover { opacity: 0.85; }
        .button.secondary { background-color: var(--secondary-color); }
        .button.success { background-color: var(--green-color); }
    </style>
</head>
<body>

    <header><h1>Hihihiai MM: Mermaid 实时渲染工具</h1></header>
    
    <div class="container">
        <div class="panel">
            <h3 class="panel-header">1. 在此粘贴或输入 Mermaid 代码 (自动渲染)</h3>
            <textarea id="mermaid-input" placeholder="例如:&#10;graph TD&#10;    A --&gt; B;"></textarea>
            <div class="actions">
                <button id="download-svg-button" class="button secondary">下载为 SVG</button>
                <button id="download-png-button" class="button success">下载为 PNG</button>
            </div>
        </div>
        
        <div class="panel">
            <h3 class="panel-header">2. 渲染结果</h3>
            <div class="output-container"><div id="graph-output"><p>请输入代码以开始...</p></div></div>
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        const inputArea = document.getElementById('mermaid-input');
        const outputDiv = document.getElementById('graph-output');
        const downloadSvgButton = document.getElementById('download-svg-button');
        const downloadPngButton = document.getElementById('download-png-button');

        let lastValidSvg = ''; // 只存储最后一次有效的SVG
        mermaid.initialize({ startOnLoad: false, theme: 'default' });

        const renderGraph = async () => {
            const graphDefinition = inputArea.value;
            if (!graphDefinition.trim()) {
                outputDiv.innerHTML = '<p>请输入代码以开始...</p>';
                lastValidSvg = '';
                return;
            }
            
            try {
                // 先检查语法是否有效，而不会直接渲染错误
                await mermaid.parse(graphDefinition);
                // 语法有效，才进行渲染
                const { svg } = await mermaid.render(`mermaid-graph-${Date.now()}`, graphDefinition);
                outputDiv.innerHTML = svg;
                lastValidSvg = svg; // 保存有效的SVG
            } catch (error) {
                // FIX 1: 隐藏报错信息。发生错误时，不做任何事，保留上一个有效图形
                console.error("Mermaid syntax error:", error.message);
            }
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        };
        
        const download = (filename, blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // --- 事件监听器 ---
        inputArea.addEventListener('input', debounce(renderGraph, 300));

        downloadSvgButton.addEventListener('click', () => {
            if (!lastValidSvg) { alert('没有可下载的图表！'); return; }
            download('mermaid-graph.svg', new Blob([lastValidSvg], { type: 'image/svg+xml;charset=utf-8' }));
        });
        
        // FIX 3: PNG下载的最终修复方案
        downloadPngButton.addEventListener('click', () => {
            if (!lastValidSvg) { alert('没有可下载的图表！'); return; }
            
            const svgElement = outputDiv.querySelector('svg');
            if (!svgElement) { alert('找不到图表元素。'); return; }

            // 从SVG的viewBox属性读取其真实的、内在的尺寸
            const viewBox = svgElement.getAttribute('viewBox');
            if (!viewBox) {
                alert('无法从图表获取准确尺寸，无法生成PNG。');
                return;
            }
            const viewBoxParts = viewBox.split(/[\s,]+/);
            const intrinsicWidth = parseFloat(viewBoxParts[2]);
            const intrinsicHeight = parseFloat(viewBoxParts[3]);
            
            if (isNaN(intrinsicWidth) || isNaN(intrinsicHeight) || intrinsicWidth <= 0 || intrinsicHeight <= 0) {
                 alert('读取到无效的图表尺寸，无法生成PNG。');
                 return;
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(lastValidSvg);

            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const padding = 20;
                const dpr = window.devicePixelRatio || 1;
                
                // 使用从viewBox读取到的真实宽高来设置画布尺寸
                canvas.width = (intrinsicWidth + padding * 2) * dpr;
                canvas.height = (intrinsicHeight + padding * 2) * dpr;

                ctx.scale(dpr, dpr);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, padding, padding, intrinsicWidth, intrinsicHeight);

                canvas.toBlob((blob) => {
                    if (blob) {
                        download('mermaid-graph.png', blob);
                    }
                }, 'image/png');
            };
            
            img.onerror = () => {
                alert("图片加载失败，无法生成PNG。");
            };
        });

        // 页面加载时，渲染一个欢迎页
        window.addEventListener('load', () => {
            inputArea.value = `graph TD
    A[欢迎使用 Mermaid Pro] --> B{输入代码, 实时预览};
    B --> C[下载SVG格式<br>矢量、清晰];
    B --> D[下载PNG格式<br>位图、方便分享];`;
            renderGraph();
        });
    </script>
</body>
</html>
